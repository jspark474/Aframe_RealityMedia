<html>

<head>
  <script>
    // WebXR requires https: to work so ensure redirected if needed.
    if (location.hostname !== 'localhost' && window.location.protocol === 'http:') window.location.protocol = 'https:';
  </script>

  <!-- the AFrame library -->
	<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
  <script src="ar-shadow-helper.js"></script>
  <script src="ar-cursor.js"></script>
  <script src="simple-navmesh-constraint.js"></script>
  <script src="model-utils.js"></script>
	<script src="main.js"></script>
  
  <script>
    const DEFAULT_HAND_PROFILE_PATH = 'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/';
    const joints = [
      'wrist',
      'thumb-metacarpal',
      'thumb-phalanx-proximal',
      'thumb-phalanx-distal',
      'thumb-tip',
      'index-finger-metacarpal',
      'index-finger-phalanx-proximal',
      'index-finger-phalanx-intermediate',
      'index-finger-phalanx-distal',
      'index-finger-tip',
      'middle-finger-metacarpal',
      'middle-finger-phalanx-proximal',
      'middle-finger-phalanx-intermediate',
      'middle-finger-phalanx-distal',
      'middle-finger-tip',
      'ring-finger-metacarpal',
      'ring-finger-phalanx-proximal',
      'ring-finger-phalanx-intermediate',
      'ring-finger-phalanx-distal',
      'ring-finger-tip',
      'pinky-finger-metacarpal',
      'pinky-finger-phalanx-proximal',
      'pinky-finger-phalanx-intermediate',
      'pinky-finger-phalanx-distal',
      'pinky-finger-tip',
    ];
    
    AFRAME.registerComponent('handy-controls', {
      schema: {
        left: {
          default: DEFAULT_HAND_PROFILE_PATH + "left.glb"
        },
        right: {
          default: DEFAULT_HAND_PROFILE_PATH + "right.glb"
        }
      },
      init () {
        const self = this;
        const dracoLoader = this.system.getDRACOLoader();
        const meshoptDecoder = this.system.getMeshoptDecoder();
        this.model = null;
        this.loader = new THREE.GLTFLoader();
        if (dracoLoader) {
          this.loader.setDRACOLoader(dracoLoader);
        }
        if (meshoptDecoder) {
          this.ready = meshoptDecoder.then(function (meshoptDecoder) {
            self.loader.setMeshoptDecoder(meshoptDecoder);
          });
        } else {
          this.ready = Promise.resolve();
        }
      },
      update () {
        const self = this;
        const el = this.el;
        const srcLeft = this.data.left;
        const srcRight = this.data.right;

        this.remove();

        this.ready.then(function () {
          
          
          self.loader.load(srcRight, function gltfLoaded (gltfModel) {
            const object = gltf.scene.children[0];
            const mesh = object.getObjectByProperty( 'type', 'SkinnedMesh' );
            mesh.frustumCulled = false;
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            joints.forEach( jointName => {
              const bone = object.getObjectByName( jointName );
              if ( bone !== undefined ) {
                bone.jointName = jointName;
              } else {
                console.warn( `Couldn't find ${jointName} in ${handedness} hand mesh` );
              }
              this.bones.push( bone );
            });

            el.setObject3D('mesh-right', mesh);
            el.emit('model-loaded', {format: 'gltf', model: mesh});
          }, undefined /* onProgress */, function gltfFailed (error) {
            const message = (error && error.message) ? error.message : 'Failed to load glTF model';
            warn(message);
            el.emit('model-error', {format: 'gltf', src: srcRight});
          });
          
          self.loader.load(srcLeft, function gltfLoaded (gltfModel) {
            self.modelLeft = gltfModel.scene || gltfModel.scenes[0];
            self.modelLeft.animations = gltfModel.animations;
            el.setObject3D('mesh-right', self.modelLeft);
            el.emit('model-loaded', {format: 'gltf', model: self.modelLeft});
          }, undefined /* onProgress */, function gltfFailed (error) {
            const message = (error && error.message) ? error.message : 'Failed to load glTF model';
            warn(message);
            el.emit('model-error', {format: 'gltf', src: srcLeft});
          });

        });
        
        const sceneEl = this.el.sceneEl;
        sceneEl.addEventListener("enter-vr", () => this.session = renderer.xr.getSession() );
        sceneEl.addEventListener("exit-vr", () => this.session = null );
      },
      tick () {
        if (!this.session) return;

        const toUpdate = [];
        const frame = this.el.sceneEl.frame;
        for (const source of session.inputSources) {
          if (!source.hand) continue;
          toUpdate.push(source);

          const model = (this.handedness === 'right' && this.modelRight) || (this.handedness === 'left' && this.modelLeft);
          if (!model) continue;
          
          // Update the model animations to the pose from the API
          
        }
        
        // perform hand tracking
        if (toUpdate.length && window.handyWorkUpdate) {
          window.handyWorkUpdate([controller], referenceSpace, frame, this.handyWorkCallback.bind(this));
        }
      }
    })
  </script>

	<script type="module">
		import {
			update as handyWorkUpdate,
			loadPose,
			dumpHands
		} from "https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/build/handy-work.js";
				
		window.handyWorkUpdate = handyWorkUpdate;

		loadPose('relax', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/relax.handpose');
		loadPose('fist', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/fist.handpose');
		loadPose('flat', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/flat.handpose');
		loadPose('point', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/point.handpose');
		loadPose('horns', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/horns.handpose');
		loadPose('shaka', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/shaka.handpose');
		loadPose('vulcan', 'https://cdn.jsdelivr.net/gh/AdaRoseCannon/handy-work@main/poses/vulcan.handpose');

		//setTimeout(dumpHands, 10000);
	</script>
  
  <style>
		body {
			font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
		}
    
    #dom-overlay-message {
      position: absolute;
      left: 0;
      bottom: 0;
      right: 0;
      padding: 1em;
      background: #33333355;
      border-top: 5px solid #ffffff55;
      color: white;
    }

    .a-dom-overlay button {
      padding: 1em;
      appearance: none;
      background: #00000055;
      border: 3px solid white;
      border-radius: 1em;
      margin: 1em 1em 0 0;
      color: white;
    }
  </style>  
</head>

<body>
	<a-scene
		webxr="overlayElement:#dom-overlay;"
		background="color:skyblue;"
		reflection="directionalLight:#dirlight;"
		ar-hit-test="target:#my-ar-objects;type:footprint;footprintDepth:0.2;"
		shadow="type: pcfsoft"
		gltf-model="dracoDecoderPath: https://cdn.jsdelivr.net/npm/three@0.129.0/examples/js/libs/draco/gltf/;"
    ar-cursor raycaster="objects: #my-ar-objects a-sphere"
    exposure="2"
	>
    <a-assets>
      <a-asset-item id="building-glb" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/venue.glb?v=1644331843500"></a-asset-item>
      <a-asset-item id="navmesh-glb" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/navmesh.glb?v=1644329586500"></a-asset-item>
      <img id="bake" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/Bake(3).webp?v=1644331344700">
      <a-mixin id="animations" animation__click="property: components.material.material.color; type: color; to: blue; startEvents: click; dur: 500;"></a-mixin>
    </a-assets>

    <a-entity position="-1 0 1" origin-on-ar-start id="cameraRig">
      <!-- camera -->
      <a-entity id="head"
        camera="near:0.01;"
        look-controls="pointerLockEnabled: false"
        position="0 1.65 0"
        wasd-controls="acceleration:30;"
        simple-navmesh-constraint="navmesh:#navmesh;fall:0.5;height:1.65;"
      ></a-entity>
      <!-- hand controls -->
      <a-entity 
                hand-controls="hand:left"
                id="left-hand"
                blink-controls="cameraRig: #cameraRig; teleportOrigin: #head; collisionEntities:#navmesh;"
      ></a-entity>
      <a-entity 
                hand-controls="hand:right"
                id="right-hand"
                blink-controls="cameraRig: #cameraRig; teleportOrigin: #head; collisionEntities:#navmesh;"
      ></a-entity>
    </a-entity>
      
    <a-entity id="my-ar-objects" position="-6 0 1">
      <!-- "Dusty Piano" (https://skfb.ly/66EPx) by Vincent074 is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/). -->
      <a-gltf-model id="piano" rotation="0 100 0" shadow="recieve:false;cast:true;" src="https://cdn.glitch.global/d29f98b4-ddd1-4589-8b66-e2446690e697/piano.glb?v=1644414775118"></a-gltf-model>
    </a-entity>

    <!-- This plane is only visible in AR and follows the given target to provide it with shadows.-->
    <a-entity
      material="shader:shadow; depthWrite:false; opacity:0.9;"
      geometry="primitive:shadow-plane;"
      visible="false"
      shadow="cast:false;receive:true;"
      ar-shadow-helper="target:#my-ar-objects;light:#dirlight;"
      position="0 0.25 0"
    ></a-entity>


    <a-entity hide-on-enter-ar position="0 -0.2 0" environment="lighting:none;shadow:true;preset: osiris;"></a-entity>
		<a-entity rotation="0 -45 0" position="0 0 0" hide-on-enter-ar>
      <a-gltf-model id="navmesh" src="#navmesh-glb" visible="false"></a-gltf-model>
      <a-gltf-model src="#building-glb"
        lightmap="src:#bake;intensity: 1.5; filter:Window,Ceiling,floor;"
        depthwrite="true"
        window-replace="Glass"
        no-tonemapping="Light"
        shadow="cast:false;receive:true;"
      ></a-gltf-model>
    </a-entity>

		<a-light id="dirlight" auto-shadow-cam intensity="0.8" light="castShadow:true;type:directional" position="0 3 -6"></a-light>

	</a-scene>

	<div id="dom-overlay">
    <h1>
      Hello World
    </h1>
		<div id="dom-overlay-message">Enter AR or VR to start.</div>
	</div>
  
  <div class="glitchButton" style="position: absolute; top: 1em; right: 1em;"></div><script src="https://button.glitch.me/button.js"></script>
</body>

</html>
